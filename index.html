<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <meta name="theme-color" content="#e6f6ff">

  <!-- PC/通常ブラウザでの表示名（長いまま） -->
  <title>花彩音3kHz歌唱曲DB</title>

  <!-- iOSでホーム画面に追加した時の名前を短くする -->
  <meta name="apple-mobile-web-app-title" content="彩興DB">
  <!-- Androidや一部ブラウザでのアプリ名 -->
  <meta name="application-name" content="彩興DB">

  <!-- PWA用マニフェスト（GASで返す場合はここをGASのexec?manifest=1にしてください） -->
  <link rel="manifest" href="/kasane-3khz-songs-db/manifest.webmanifest">

  <!-- 汎用ICO（最優先の後方互換） -->
  <link rel="icon" href="/kasane-3khz-songs-db/favicon.ico" sizes="any">

  <!-- PNG各サイズ（ブラウザの最適サイズ選択用） -->
  <link rel="icon" href="/kasane-3khz-songs-db/favicon-16.png"  sizes="16x16"   type="image/png">
  <link rel="icon" href="/kasane-3khz-songs-db/favicon-32.png"  sizes="32x32"   type="image/png">
  <link rel="icon" href="/kasane-3khz-songs-db/favicon-48.png"  sizes="48x48"   type="image/png">
  <link rel="icon" href="/kasane-3khz-songs-db/favicon-64.png"  sizes="64x64"   type="image/png">
  <link rel="icon" href="/kasane-3khz-songs-db/favicon-128.png" sizes="128x128" type="image/png">
  <link rel="icon" href="/kasane-3khz-songs-db/favicon-192.png" sizes="192x192" type="image/png">
  <link rel="icon" href="/kasane-3khz-songs-db/favicon-256.png" sizes="256x256" type="image/png">
  <link rel="icon" href="/kasane-3khz-songs-db/favicon-512.png" sizes="512x512" type="image/png">

  <!-- iPhone ホーム追加用 -->
  <link rel="apple-touch-icon" href="/kasane-3khz-songs-db/apple-touch-icon-180.png" sizes="180x180">

  <style>
    :root{
      --bg:#e6f6ff;
      --card:#ffffff;
      --text:#1a1a1a;
      --muted:#6b7280;
      --line:#e5e7eb;
      --thead:#dff1ff;
      --focus:#97f0b6;
      --tab-bg:#ffffff;
      --tab-active:#c8e7ff;
      --tab-border:#cbd5e1;
      --link:#2563eb;
      --chip-bg:#f3f4f6;
      --chip-text:#111827;
    }
    *{box-sizing:border-box}
    body{
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      line-height:1.7;
      margin:12px
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      box-shadow:0 2px 10px rgba(0,0,0,.06)
    }

    .topbar{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      justify-content:space-between;
      margin-bottom:8px
    }
    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap
    }
    .tab{
      appearance:none;
      border:1px solid var(--tab-border);
      background:var(--tab-bg);
      color:var(--text);
      border-radius:999px;
      padding:8px 14px;
      font-size:14px;
      cursor:pointer
    }
    .tab[aria-selected="true"]{
      background:var(--tab-active);
      font-weight:700
    }
    /* ←ここでタブだけフォーカスリングを抑制し、キーボード操作時だけ出す */
    .tab:focus{
      outline:none;
    }
    .tab:focus-visible{
      outline:3px solid var(--focus);
      outline-offset:2px;
    }

    .limit-wrap{
      display:flex;
      align-items:center;
      gap:8px
    }
    #limit{
      padding:6px 10px;
      font-size:14px;
      line-height:1.2;
      width:auto;
      min-width:120px
    }

    /* 検索＋トグル */
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:4px
    }
    .search-wrap{
      flex:1 1 auto;
      min-width:180px
    }
    .search-wrap input[type="search"]{width:100%}

    input[type="search"],select{
      padding:12px 14px;
      border:1px solid var(--line);
      border-radius:12px;
      font-size:16px;
      background:#fff;
      color:var(--text);
      outline:none
    }
    /* こっちは今までどおりミントで出す */
    input[type="search"]:focus,
    select:focus,
    .btn:focus,
    .link-icon:focus,
    .link-btn:focus{
      outline:3px solid var(--focus);
      outline-offset:2px;
    }

    .sort-toggle{
      appearance:none;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      border-radius:10px;
      padding:6px 10px;
      font-size:13px;
      cursor:pointer;
      white-space:nowrap;
    }
    .sort-toggle:focus{
      outline:3px solid var(--focus);
      outline-offset:2px;
    }

    /* 折りたたみ並べ替えバー（初回非表示） */
    .sortbar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:6px;
      max-height:0;
      overflow:hidden;
      transition:max-height .2s ease;
    }
    .sortbar.open{
      max-height:80px;
    }
    .sort-btn{
      appearance:none;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text); /* 黒で統一 */
      border-radius:999px;
      padding:4px 12px;
      font-size:13px;
      cursor:pointer;
      line-height:1.4;
    }
    .sort-btn.active{
      background:#e0f2ff;
      border-color:#93c5fd;
      font-weight:600;
      color:var(--text);
    }

    .dm-wrap{
      display:flex;
      align-items:center;
      gap:8px;
      margin-top:8px
    }
    .dm-select-wrap{flex:7 1 0}
    .dm-btn-wrap{flex:3 1 0;display:flex}
    #dm-select{
      width:100%;
      padding:6px 10px;
      font-size:14px;
      line-height:1.2
    }
    .btn{
      appearance:none;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      border-radius:10px;
      padding:8px 12px;
      font-size:14px;
      cursor:pointer
    }
    .btn:hover{background:#f9fafb}
    .btn:active{transform:translateY(1px)}
    .btn-full{width:100%}

    .muted{color:var(--muted);font-size:13px}
    .toast{
      position:fixed;
      left:50%;
      bottom:16px;
      transform:translateX(-50%);
      background:rgba(17,24,39,.92);
      color:#fff;
      padding:10px 14px;
      border-radius:10px;
      font-size:14px;
      opacity:0;
      transition:opacity .2s
    }
    .toast.show{opacity:1}

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      table-layout:fixed
    }
    th,td{
      border-bottom:1px solid var(--line);
      padding:10px 8px;
      font-size:15px;
      vertical-align:top
    }
    th{
      position:sticky;
      top:0;
      background:var(--thead);
      z-index:1;
      font-weight:700
    }
    th:nth-child(1),td:nth-child(1){width:28%}
    th:nth-child(2),td:nth-child(2){width:40%}
    th:nth-child(3),td:nth-child(3){width:32%}
    .ops{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:8px;
      flex-wrap:wrap
    }
    .link-icon{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:36px;
      height:36px;
      line-height:1;
      text-decoration:none;
      font-size:18px;
      border-radius:8px
    }
    .link-icon:hover{background:#f3f4f6}
    .link-icon:active{transform:translateY(1px)}

    .kind-chip{
      display:inline-flex;
      align-items:center;
      max-width:100%;
      padding:4px 8px;
      border-radius:999px;
      font-size:13px;
      background:var(--chip-bg);
      color:var(--chip-text);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      border:1px solid var(--line);
    }

    @media (max-width:768px){
      .row{flex-wrap:nowrap}
      .search-wrap{flex:1 1 auto}
      .sort-toggle{flex:0 0 auto}
      table{display:none}
      .mobile-list{display:block;margin-top:10px}
      .item{
        border-bottom:1px solid var(--line);
        padding:12px 2px;
        display:flex;
        flex-direction:column;
        gap:6px
      }
      .l1{
        font-size:16px;
        line-height:1.6;
        font-weight:700;
        display:flex;
        gap:6px;
        flex-wrap:wrap
      }
      .l1 .sep{opacity:.6}
      .l2{
        display:flex;
        align-items:center;
        gap:8px;
        justify-content:flex-end;
        flex-wrap:wrap
      }
    }

    .page{display:none}.page.active{display:block}
    .history-header{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:8px
    }
    .back{
      appearance:none;
      border:1px solid var(--line);
      background:#fff;
      border-radius:10px;
      padding:8px 12px;
      font-size:14px;
      cursor:pointer
    }
    .back:hover{background:#f9fafb}
    .title{font-weight:700}
    .history-list{margin-top:8px}
    .history-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:1px solid var(--line);
      padding:10px 4px;
      gap:8px
    }
    .history-left{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0
    }
    .history-date{white-space:nowrap;color:#374151}
    .history-item a{color:var(--link);text-decoration:none}
    .history-item a:hover{text-decoration:underline}
    .skeleton{
      height:16px;
      background:#eef6ff;
      border-radius:6px;
      margin:6px 0
    }
  </style>
</head>
<body>
  <!-- 一覧ページ -->
  <div id="page-list" class="page active">
    <div class="card">
      <div class="topbar">
        <div class="tabs" role="tablist" aria-label="検索対象">
          <button id="tab-songs" class="tab" role="tab" aria-selected="true"  data-tab="songs">歌唱曲</button>
          <button id="tab-gags"  class="tab" role="tab" aria-selected="false" data-tab="gags">一発ネタ</button>
        </div>
        <div class="limit-wrap">
          <label for="limit" class="muted" style="white-space:nowrap;">表示</label>
          <select id="limit" aria-label="表示">
            <option value="10" selected>10件</option>
            <option value="50">50件</option>
            <option value="all">全て</option>
          </select>
        </div>
      </div>

      <!-- 検索＋並べ替えトグル -->
      <div class="row">
        <div class="search-wrap">
          <input id="q" type="search" placeholder="曲名／アーティスト名で検索" autocomplete="off">
        </div>
        <button type="button" id="sort-toggle" class="sort-toggle" aria-expanded="false" aria-controls="sortbar">並べ替え</button>
      </div>

      <!-- 折りたたみ並べ替え -->
      <div class="sortbar" id="sortbar" aria-label="並べ替え">
        <button type="button" class="sort-btn" data-sort="title" id="sort-title">楽曲名順↑</button>
        <button type="button" class="sort-btn" data-sort="artist" id="sort-artist">歌手名順↑</button>
        <button type="button" class="sort-btn" data-sort="date" id="sort-date">投稿日順↓</button>
      </div>

      <div class="dm-wrap" aria-label="弾幕コピー">
        <div class="dm-select-wrap">
          <select id="dm-select" title="弾幕の種類を選択">
            <option value="⚛️🌐ꕤ.‎˖٭*⚛️🌐ꕤ.‎˖٭*⚛️🌐ꕤ.‎˖٭*⚛️🌐ꕤ.‎˖٭*">⚛️🌐ꕤ.‎˖٭（花）</option>
            <option value="⚛️🌐♬*.+⚛️🌐♬*.+⚛️🌐♬*.+⚛️🌐♬*.+">⚛️🌐♬*.+（音符）</option>
            <option value="✨⚛️🌐🎵✨⚛️🌐🎵✨⚛️🌐🎵✨⚛️🌐🎵">✨⚛️🌐🎵（キラ音符）</option>
          </select>
        </div>
        <div class="dm-btn-wrap">
          <button id="dm-copy" class="btn btn-full" type="button" title="選択した弾幕をコピー">コピー</button>
        </div>
      </div>

      <div class="muted" id="status">読み込み中…</div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="muted" id="hint">検索結果がここに表示されます。</div>
      <div id="table" style="display:none;"></div>
      <div id="mblist" class="mobile-list" style="display:none;"></div>
    </div>
  </div>

  <!-- 履歴ページ -->
  <div id="page-history" class="page">
    <div class="card">
      <div class="history-header">
        <button id="btn-back" class="back">← 戻る</button>
        <div class="title" id="hist-title">/</div>
      </div>
      <div class="muted" id="hist-sub">歌唱履歴を新しい順に表示します。</div>
    </div>
    <div class="card" style="margin-top:12px;">
      <div id="hist-list" class="history-list"></div>
      <div id="hist-empty" class="muted" style="display:none;">該当する履歴が見つかりませんでした。</div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">コピーしました</div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbwybI81qIBMYN3AYNuPiD4WjPNYHYWa8wkC2tp2Vfx8hedoHKe-boZPa6KRtGZCNoJpXQ/exec';
    const HARD_LIMIT = 10000;
    const ARCHIVE_VERSION = 'v2.5';

    const state = {
      current: 'songs',
      cache: { songs:null, gags:null },
      rows: [],
      debounce: null,
      archiveRaw: null,
      archiveByKey: null,
      archiveByTitle: null,
      lastScroll: 0,
      histKey: null,
      sort: { key: 'date', dir: 'desc' },
      sortEnabled: false
    };

    const $ = id => document.getElementById(id);
    const normalize = s => (s||'').toString().toLowerCase().replace(/\s+/g,' ').trim();
    const showToast = msg => { const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400); };
    async function copyText(text){
      try{
        if(navigator.clipboard?.writeText) await navigator.clipboard.writeText(text);
        else{
          const ta=document.createElement('textarea');
          ta.value=text; document.body.appendChild(ta); ta.select();
          document.execCommand('copy'); ta.remove();
        }
        showToast('コピーしました');
      }catch{
        showToast('コピーに失敗しました');
      }
    }
    async function copyPair(title, artist){
      const text = `${(title||'').trim()} / ${(artist||'').trim()}`.trim();
      await copyText(text);
    }
    document.getElementById('dm-copy').addEventListener('click', ()=>{
      const v = $('dm-select').value || '';
      copyText(v);
    });

    const urlFromText = s => { if(!s) return ''; const m=String(s).match(/https?:\/\/\S+/); return m ? m[0].replace(/[)\]\s]+$/,'') : ''; };
    const extractDate8 = s => { const m=/^(\d{8})/.exec(String(s||'')); return m ? parseInt(m[1],10) : 0; };

    function showPage(id){
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      $(id).classList.add('active');
    }

    function buildArchiveIndex(rows){
      const byKey = new Map();
      const byTitle = new Map();
      for(const r of rows){
        const a = normalize(r.artist), t = normalize(r.title);
        const url = r.dUrl || urlFromText(r.dText);
        if(!url) continue;
        const date = extractDate8(r.dText);
        const kind = (r.kind || '').toString();
        const key = `${a}|${t}`, tkey = t;
        (byKey.get(key)  || byKey.set(key,[]).get(key)).push({date,url,kind});
        (byTitle.get(tkey)|| byTitle.set(tkey,[]).get(tkey)).push({date,url,kind});
      }
      const sortDesc = arr => arr.sort((x,y)=> y.date - x.date || (x.url>y.url?1:-1));
      for(const arr of byKey.values()) sortDesc(arr);
      for(const arr of byTitle.values()) sortDesc(arr);
      state.archiveByKey = byKey;
      state.archiveByTitle = byTitle;
    }

    function tryLoadArchiveFromCache(){
      try{
        const ver = localStorage.getItem('archiveVersion');
        const json = localStorage.getItem('archiveJson');
        if(ver===ARCHIVE_VERSION && json){
          const rows = JSON.parse(json);
          state.archiveRaw = rows;
          buildArchiveIndex(rows);
          return true;
        }
      }catch{}
      return false;
    }
    function saveArchiveToCache(rows){
      try{
        localStorage.setItem('archiveVersion', ARCHIVE_VERSION);
        localStorage.setItem('archiveJson', JSON.stringify(rows));
        localStorage.setItem('archiveUpdatedAt', String(Date.now()));
      }catch{}
    }

    let __jsonpHit = false;
    function onGviz(payload){
      __jsonpHit = true;
      try{
        if (!payload || !Array.isArray(payload.rows)) {
          const name = (payload && (payload.sheet || payload.sheetName || payload.name)) ? String(payload.sheet || payload.sheetName || payload.name) : 'unknown';
          if (state.histKey) {
            $('hist-list').innerHTML = '';
            $('hist-empty').style.display = 'block';
            $('hist-sub').textContent = '履歴の取得に失敗しました。';
          } else {
            $('status').textContent = `データ取得（${name}）に失敗しました`;
          }
          return;
        }

        const rawSheet = String(payload.sheet || payload.sheetName || payload.name || '').toLowerCase();
        const looksArchive = payload.rows.length > 0 && payload.rows[0] && (
          ('dText' in payload.rows[0]) || ('dtext' in payload.rows[0]) ||
          ('dUrl' in payload.rows[0])  || ('durl' in payload.rows[0])
        );
        const tab = rawSheet || (looksArchive && state.histKey ? 'archive' : '');

        if (tab === 'archive') {
          const rows = (payload.rows||[]).map(r => ({
            artist: r.artist ?? r.Artist ?? r.アーティスト ?? '',
            title : r.title  ?? r.Title  ?? r.曲名       ?? '',
            kind  : r.kind   ?? r.Kind   ?? r.区分       ?? '',
            dText : r.dText  ?? r.dtext  ?? r.DTEXT      ?? r.text ?? '',
            dUrl  : r.dUrl   ?? r.durl   ?? r.DURL       ?? r.url  ?? ''
          }));
          state.archiveRaw = rows;
          buildArchiveIndex(rows);
          saveArchiveToCache(rows);
          if (state.histKey) renderHistory(state.histKey.artist, state.histKey.title);
          return;
        }

        if (tab === 'songs' || tab === 'gags') {
          const rows = (payload.rows||[])
            .map(r => {
              const artist = r.artist ?? r.Artist ?? r.アーティスト ?? '';
              const title  = r.title  ?? r.Title  ?? r.曲名       ?? '';
              const dText  = r.dText  ?? r.dtext  ?? r.DTEXT      ?? r.text ?? '';
              const dUrl   = r.dUrl   ?? r.durl   ?? r.DURL       ?? r.url  ?? '';
              const kind   = r.kind   ?? r.Kind   ?? r.区分       ?? '';
              const _na = normalize(artist);
              const _nt = normalize(title);
              const _date = extractDate8(dText);
              return { artist, title, kind, dText, dUrl, _na, _nt, _date };
            })
            .filter(r => ((r.artist||'')+(r.title||'')).trim()!=='');
          state.cache[tab] = rows;

          if (state.cache[state.current]) {
            state.rows = state.cache[state.current] || [];
            $('status').textContent = `読み込み完了：${state.rows.length}件`;
            render();
          } else {
            $('status').textContent = '読み込み中…';
          }
          return;
        }

        if (state.histKey && looksArchive) {
          const rows = (payload.rows||[]).map(r => ({
            artist: r.artist ?? '',
            title : r.title  ?? '',
            kind  : r.kind   ?? r.区分   ?? '',
            dText : r.dText  ?? r.text  ?? '',
            dUrl  : r.dUrl   ?? r.url   ?? ''
          }));
          state.archiveRaw = rows;
          buildArchiveIndex(rows);
          saveArchiveToCache(rows);
          renderHistory(state.histKey.artist, state.histKey.title);
          return;
        }

        if (state.histKey) {
          $('hist-list').innerHTML = '';
          $('hist-empty').style.display = 'block';
          $('hist-sub').textContent = '不明なレスポンスを受信しました。';
        } else {
          $('status').textContent = '不明なレスポンスを受信しました。';
        }
      }catch(e){
        console.error(e);
        if (state.histKey) {
          $('hist-list').innerHTML = '';
          $('hist-empty').style.display = 'block';
          $('hist-sub').textContent = '履歴の描画に失敗しました。';
        } else {
          $('status').textContent='読み込みに失敗しました';
        }
      }
    }
    window.onGviz = onGviz;

    setTimeout(()=>{
      if(!__jsonpHit && $('page-list').classList.contains('active')){
        $('status').textContent = 'データ取得に失敗しました（JSONP未着／API_URLとデプロイ設定を確認）';
      }
    }, 4000);

    function jsonp(url){
      const s=document.createElement('script');
      s.src=url;
      s.onerror=()=>{ if ($('page-list').classList.contains('active')) $('status').textContent='データ取得に失敗しました（ネットワーク/ブロック）'; };
      document.head.appendChild(s);
    }
    function requestData(tab){
      const base = API_URL.replace(/\/macros\/u\/\d+\//,'/macros/');
      const url  = `${base}?callback=onGviz&sheet=${encodeURIComponent(tab)}&authuser=0&v=${Date.now()}`;
      jsonp(url);
    }
    function requestCurrent(tab){
      if (!state.cache[tab]) requestData(tab);
    }
    function ensureArchiveFast(){
      const ok = tryLoadArchiveFromCache();
      if (!ok) requestData('archive');
    }

    function setActiveTab(tab){
      state.current = tab;
      document.querySelectorAll('.tab').forEach(b => b.setAttribute('aria-selected', String(b.dataset.tab===tab)));
      $('status').textContent='読み込み中…';
      requestCurrent(tab);
      if (state.cache[tab]) {
        state.rows = state.cache[tab];
        $('status').textContent = `表示中：${state.rows.length}件`;
        render();
      }
      updateSortUI();
    }

    function renderHistory(artist, title){
      state.histKey = { artist, title };
      $('hist-title').textContent = `${artist || ''} / ${title || ''}`;

      const wrap = $('hist-list');
      const empty = $('hist-empty');
      wrap.innerHTML = '';
      empty.style.display = 'none';

      if (!state.archiveByKey || !state.archiveByTitle) {
        ensureArchiveFast();
        for(let i=0;i<6;i++){
          const sk=document.createElement('div');
          sk.className='skeleton';
          wrap.appendChild(sk);
        }
        $('hist-sub').textContent = '履歴を読み込み中…';
        return;
      }

      const key = `${normalize(artist)}|${normalize(title)}`;
      let list = state.archiveByKey.get(key);
      if (!list || list.length===0) list = state.archiveByTitle.get(normalize(title)) || [];

      if (list.length===0){
        empty.style.display = 'block';
        return;
      }

      $('hist-sub').textContent = '新しい順に表示しています。';

      const CHUNK = 50;
      let i = 0;
      function drawChunk(){
        const frag = document.createDocumentFragment();
        const end = Math.min(i+CHUNK, list.length);
        for(; i<end; i++){
          const {date,url,kind} = list[i];
          const yyyy = Math.floor(date/10000), mm=Math.floor((date%10000)/100), dd=date%100;
          const dateLabel = date ? `${yyyy}/${String(mm).padStart(2,'0')}/${String(dd).padStart(2,'0')}` : '----/--/--';

          const row = document.createElement('div'); row.className='history-item';

          const left = document.createElement('div'); left.className='history-left';
          const dt = document.createElement('span');
          dt.className = 'history-date';
          dt.textContent = dateLabel;
          left.appendChild(dt);
          if ((kind || '').trim() !== '') {
            const k = document.createElement('span');
            k.className = 'kind-chip';
            k.textContent = kind;
            left.appendChild(k);
          }

          const right = document.createElement('div');
          if (url) {
            const a=document.createElement('a');
            a.href=url; a.target='_blank'; a.rel='noopener'; a.textContent='▶ 開く';
            right.appendChild(a);
          } else {
            const span=document.createElement('span');
            span.className='muted'; span.textContent='リンクなし';
            right.appendChild(span);
          }

          row.appendChild(left); row.appendChild(right);
          frag.appendChild(row);
        }
        wrap.appendChild(frag);
        if (i < list.length) requestAnimationFrame(drawChunk);
      }
      requestAnimationFrame(drawChunk);
    }

    function updateSortUI(){
      const titleBtn = $('sort-title');
      const artistBtn = $('sort-artist');
      const dateBtn   = $('sort-date');

      if (!state.sortEnabled) {
        titleBtn.classList.remove('active');
        artistBtn.classList.remove('active');
        dateBtn.classList.remove('active');
        titleBtn.textContent  = '楽曲名順↑';
        artistBtn.textContent = '歌手名順↑';
        dateBtn.textContent   = '投稿日順↓';
        return;
      }

      const { key, dir } = state.sort;

      titleBtn.classList.remove('active');
      artistBtn.classList.remove('active');
      dateBtn.classList.remove('active');

      if (key === 'title') {
        titleBtn.classList.add('active');
        titleBtn.textContent = dir === 'asc' ? '楽曲名順↑' : '楽曲名順↓';
        artistBtn.textContent = '歌手名順↑';
        dateBtn.textContent   = '投稿日順↓';
      } else if (key === 'artist') {
        artistBtn.classList.add('active');
        artistBtn.textContent = dir === 'asc' ? '歌手名順↑' : '歌手名順↓';
        titleBtn.textContent  = '楽曲名順↑';
        dateBtn.textContent   = '投稿日順↓';
      } else if (key === 'date') {
        dateBtn.classList.add('active');
        dateBtn.textContent   = dir === 'desc' ? '投稿日順↓' : '投稿日順↑';
        titleBtn.textContent  = '楽曲名順↑';
        artistBtn.textContent = '歌手名順↑';
      }
    }

    function render(){
      const tableWrap = $('table'); tableWrap.innerHTML = '';
      const listWrap  = $('mblist'); listWrap.innerHTML = '';
      const hint = $('hint');

      if (!state.cache[state.current]) {
        $('status').textContent = '読み込み中…';
        tableWrap.style.display = 'none';
        listWrap.style.display  = 'none';
        return;
      }

      const q = normalize($('q').value||'');
      const rawLimit = $('limit').value;
      const limitParsed = (rawLimit === 'all') ? Number.POSITIVE_INFINITY : parseInt(rawLimit,10) || 10;
      const effectiveLimit = Math.min(limitParsed, HARD_LIMIT);

      let filtered = state.cache[state.current] || [];
      if(q){
        filtered = filtered.filter(r => r._na.includes(q) || r._nt.includes(q));
      }

      if (state.sortEnabled) {
        const { key, dir } = state.sort;
        filtered = filtered.slice().sort((a,b)=>{
          if (key === 'title') {
            const res = a._nt.localeCompare(b._nt, 'ja');
            return dir === 'asc' ? res : -res;
          } else if (key === 'artist') {
            const res = a._na.localeCompare(b._na, 'ja');
            return dir === 'asc' ? res : -res;
          } else if (key === 'date') {
            const ad = a._date || 0;
            const bd = b._date || 0;
            const res = ad - bd;
            return dir === 'asc' ? res : -res;
          }
          return 0;
        });
      }

      const rows = filtered.slice(0, effectiveLimit);

      const limitLabel = (rawLimit === 'all') ? '全て' : `${effectiveLimit}件`;
      $('status').textContent = q
        ? `${rows.length}件ヒット（全${filtered.length}件）／表示上限 ${limitLabel}`
        : `表示中 ${rows.length}件（全${(state.cache[state.current]||[]).length}件）／表示上限 ${limitLabel}`;

      if(rows.length===0){
        hint.textContent = q ? '該当なし' : '検索結果がここに表示されます。';
        tableWrap.style.display = 'none';
        listWrap.style.display  = 'none';
        return;
      }
      hint.textContent = '';

      const isMobile = window.matchMedia('(max-width: 768px)').matches;
      const latestUrl = (r)=> r.dUrl || urlFromText(r.dText);

      if (!isMobile) {
        const table=document.createElement('table');
        const thead=document.createElement('thead');
        const trh=document.createElement('tr');
        ['アーティスト名','曲名','操作'].forEach(h=>{
          const th=document.createElement('th'); th.textContent=h; trh.appendChild(th);
        });
        thead.appendChild(trh); table.appendChild(thead);

        const tbody=document.createElement('tbody');
        rows.forEach(({artist,title,kind,dText,dUrl})=>{
          const tr=document.createElement('tr');

          let td=document.createElement('td'); td.textContent=artist||''; tr.appendChild(td);
          td=document.createElement('td'); td.textContent=title||''; tr.appendChild(td);

          const tdOps=document.createElement('td');
          const ops=document.createElement('div'); ops.className='ops';

          if ((kind||'').trim()!==''){
            const k=document.createElement('span'); k.className='kind-chip'; k.textContent=kind;
            ops.appendChild(k);
          }

          const url = latestUrl({dText,dUrl});
          if (url){
            const a=document.createElement('a'); a.href=url; a.target='_blank'; a.rel='noopener'; a.className='link-icon'; a.textContent='▶'; a.title='リンクを開く';
            ops.appendChild(a);
          }

          const hbtn=document.createElement('button'); hbtn.className='btn'; hbtn.textContent='履歴';
          hbtn.addEventListener('click', ()=>{
            state.lastScroll = window.scrollY || document.documentElement.scrollTop || 0;
            showPage('page-history');
            if (!state.archiveByKey) ensureArchiveFast();
            renderHistory(artist, title);
          });
          ops.appendChild(hbtn);

          const btn=document.createElement('button'); btn.className='btn'; btn.textContent='コピー';
          btn.addEventListener('click', ()=>copyPair(title,artist));
          ops.appendChild(btn);

          tdOps.appendChild(ops); tr.appendChild(tdOps); tbody.appendChild(tr);
        });
        table.appendChild(tbody); tableWrap.appendChild(table);
        tableWrap.style.display = 'block'; listWrap.style.display = 'none';
      } else {
        rows.forEach(({artist,title,kind,dText,dUrl})=>{
          const item=document.createElement('div'); item.className='item';
          const l1=document.createElement('div'); l1.className='l1';
          const a1=document.createElement('span'); a1.className='artist'; a1.textContent=artist||'';
          const sep=document.createElement('span'); sep.className='sep'; sep.textContent='/';
          const t1=document.createElement('span'); t1.className='title'; t1.textContent=title||'';
          l1.appendChild(a1); l1.appendChild(sep); l1.appendChild(t1);

          const l2=document.createElement('div'); l2.className='l2';

          if ((kind||'').trim()!==''){
            const k=document.createElement('span'); k.className='kind-chip'; k.textContent=kind;
            l2.appendChild(k);
          }

          const url = latestUrl({dText,dUrl});
          if (url){
            const a=document.createElement('a'); a.href=url; a.target='_blank'; a.rel='noopener'; a.className='link-icon'; a.textContent='▶'; a.title='リンクを開く';
            l2.appendChild(a);
          }

          const hbtn=document.createElement('button'); hbtn.className='btn'; hbtn.textContent='履歴';
          hbtn.addEventListener('click', ()=>{
            state.lastScroll = window.scrollY || document.documentElement.scrollTop || 0;
            showPage('page-history');
            if (!state.archiveByKey) ensureArchiveFast();
            renderHistory(artist, title);
          });
          l2.appendChild(hbtn);

          const btn=document.createElement('button'); btn.className='btn'; btn.textContent='コピー';
          btn.addEventListener('click', ()=>copyPair(title,artist));
          l2.appendChild(btn);

          item.appendChild(l1); item.appendChild(l2); $('mblist').appendChild(item);
        });
        $('mblist').style.display = 'block'; $('table').style.display = 'none';
      }

      updateSortUI();
    }

    function handleSortClick(key){
      if (!state.sortEnabled) {
        state.sortEnabled = true;
      }
      if (state.sort.key === key) {
        state.sort.dir = (state.sort.dir === 'asc') ? 'desc' : 'asc';
      } else {
        state.sort.key = key;
        state.sort.dir = (key === 'date') ? 'desc' : 'asc';
      }
      render();
    }

    $('btn-back').addEventListener('click', ()=>{
      showPage('page-list'); window.scrollTo({ top: state.lastScroll || 0 });
    });

    $('sort-toggle').addEventListener('click', ()=>{
      const bar = $('sortbar');
      const btn = $('sort-toggle');
      const isOpen = bar.classList.toggle('open');
      btn.setAttribute('aria-expanded', String(isOpen));
    });

    window.addEventListener('resize', ()=>{
      clearTimeout(state.debounce);
      state.debounce=setTimeout(render,150);
    });

    (function init(){
      document.getElementById('tab-songs').addEventListener('click', ()=> setActiveTab('songs'));
      document.getElementById('tab-gags').addEventListener('click',  ()=> setActiveTab('gags'));
      $('q').addEventListener('input', ()=>{
        clearTimeout(state.debounce);
        state.debounce=setTimeout(render,200);
      });
      $('limit').addEventListener('change', render);

      $('sort-title').addEventListener('click', ()=>handleSortClick('title'));
      $('sort-artist').addEventListener('click', ()=>handleSortClick('artist'));
      $('sort-date').addEventListener('click', ()=>handleSortClick('date'));

      showPage('page-list');
      setActiveTab('songs');
      if (!state.cache['songs']) requestData('songs');
      if (!state.cache['gags'])  requestData('gags');

      ensureArchiveFast();
      updateSortUI();
    })();
  </script>
</body>
</html>
